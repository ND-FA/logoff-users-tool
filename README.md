# Logoff Users Tool

Утилита для принудительного завершения сеансов пользователей на удаленном сервере Windows с предварительным уведомлением.

![Скриншот приложения](https://github.com/user-attachments/assets/691ff028-aa8e-478d-aa03-7766a3888beb)

## Описание

Это приложение для Windows, созданное с использованием Windows Forms и .NET, которое позволяет системным администраторам или другим пользователям с соответствующими правами:
1.  Найти все активные сеансы на указанном сервере.
2.  Отправить текстовые уведомления всем пользователям в активных сеансах.
3.  Запустить таймер обратного отсчета.
4.  Периодически отправлять уведомления с оставшимся временем.
5.  По истечении таймера принудительно завершить все активные сеансы.

Это может быть полезно при проведении технических работ на сервере, когда необходимо, чтобы все пользователи сохранили свою работу и вышли из системы.

## Функциональные возможности

- **Выбор сервера**: Укажите имя или IP-адрес целевого сервера.
- **Поиск серверов**: Автоматический поиск доступных серверов в сети.
- **Настраиваемый таймер**: Установите общее время (в секундах) до завершения сеансов.
- **Интервал уведомлений**: Задайте, как часто (в секундах) пользователи будут получать всплывающие окна с напоминанием.
- **Пользовательский текст сообщения**: Вы можете изменить основной текст сообщения, отправляемого пользователям.
- **Иконка приложения**: Используется кастомная иконка для лучшей узнаваемости.
- **Управление процессом**: Кнопки "Старт", "Стоп" для запуска и прерывания процесса.
- **Логирование**: Все действия, найденные сессии и ошибки отображаются в окне приложения.
- **Сохранение настроек**:
    - Приложение автоматически сохраняет последние использованные параметры (сервер, таймер, интервал, сообщение), а также размер и положение окна, и загружает их при следующем запуске.
    - Есть возможность сохранять и загружать "Настройки по умолчанию".
- **Сброс настроек**: Кнопка для быстрой загрузки настроек по умолчанию.

## Как это работает

1.  **Получение сессий**: Приложение использует Windows Terminal Services API (WTS) для запроса списка активных сессий на удаленном сервере.
2.  **Отправка сообщений**: Используя то же API, утилита отправляет всплывающие окна с заданным текстом на рабочие столы пользователей в найденных сессиях.
3.  **Обратный отсчет**: Запускается асинхронный таймер. С определенным интервалом он снова отправляет сообщения, автоматически добавляя к тексту информацию об оставшемся времени (`(Осталось: X мин.)`).
4.  **Завершение сеансов**: По истечении таймера приложение снова использует WTS API для принудительного завершения каждого активного сеанса.
5. **Поиск серверов**: При нажатии на кнопку поиска, приложение использует PowerShell для получения списка серверов из Active Directory.

## Использование

1.  **Сервер**: Введите имя хоста или IP-адрес сервера, на котором нужно завершить сеансы. Вы также можете использовать кнопку **Поиск** для автоматического обнаружения серверов.
2.  **Таймер (секунды)**: Установите общее время до завершения сеансов. Например, `900` для 15 минут.
3.  **Интервал уведомлений (сек)**: Установите частоту напоминаний. Например, `60`, чтобы отправлять уведомления каждую минуту.
4.  **Сообщение**: Введите основной текст уведомления. Например: `Сервер будет перезагружен для проведения технических работ. Пожалуйста, сохраните все открытые документы.` К этому тексту будет автоматически добавлено оставшееся время.
5.  **Старт**: Нажмите для запуска процесса.
6.  **Стоп**: Нажмите, чтобы прервать обратный отсчет. Завершения сеансов не произойдет.
7.  **Очистить**: Очищает окно с логами.
8.  **Настройки**: Открывает окно для редактирования и сохранения настроек по умолчанию.
9.  **Сброс**: Загружает в поля на главной форме сохраненные настройки по умолчанию.
10. **Поиск**: Инициирует поиск серверов в сети.

## Конфигурация

Приложение создает файл `settings-tool.json` в папке "Мои документы" текущего пользователя, от имени которого запущено приложение. Этот файл содержит три основные секции:

- `DefaultSettings`: Настройки по умолчанию, которые можно загрузить, нажав на кнопку "По умолчанию". Их можно изменить в окне "Настройки".
- `LastUsedSettings`: Настройки, которые были в полях ввода в момент закрытия приложения. Они загружаются автоматически при следующем запуске.
- `Application`: Настройки самого приложения, такие как версия, дата последнего запуска, а также размер и положение окна.

```json
{
  "DefaultSettings": {
    "Server": "test",
    "TimerSeconds": 900,
    "NotificationInterval": 60,
    "Message": "Все сеансы на данном сервере будут завершены. Сохраните документы и выйдите из системы!"
  },
  "LastUsedSettings": {
    "Server": "test-server",
    "TimerSeconds": 1800,
    "NotificationInterval": 120,
    "Message": "Все сеансы на данном сервере будут завершены. Сохраните документы и выйдите из системы!"
  },
  "Application": {
    "Version": "1.1.0",
    "LastRun": "2023-10-27T10:00:00.0000000+00:00",
    "Width": 800,
    "Height": 600,
    "X": 100,
    "Y": 100
  }
}
```

## Сборка из исходного кода

Для сборки проекта вам понадобится .NET SDK.

1.  Клонируйте репозиторий.
2.  Откройте терминал в корневой папке проекта.
3.  Выполните следующую команду для сборки самодостаточного исполняемого файла (`.exe`):

```bash
dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true
```

Собранный файл будет находиться в папке `bin/Release/net8.0-windows/win-x64/publish/`.

## Используемые технологии

-   .NET / C#
-   Windows Forms
-   Windows Terminal Services (WTS) API
-   PowerShell

## Лицензия

Этот проект распространяется под лицензией MIT.
